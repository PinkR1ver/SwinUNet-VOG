---
description: "SwinUNet-VOG 系统架构、模块设计、数据流"
alwaysApply: false
---

# 系统架构

## 整体架构

```
┌─────────────────────────────────────────────────────────────────┐
│                      SwinUNet-VOG 系统                          │
├─────────────────────────────────────────────────────────────────┤
│  ┌───────────┐  ┌───────────┐  ┌───────────┐  ┌───────────┐    │
│  │   训练    │  │   评估    │  │ GUI 可视化│  │ Web 部署  │    │
│  │ train.py  │  │ test.py   │  │gui_visual │  │  js/      │    │
│  └─────┬─────┘  └─────┬─────┘  └─────┬─────┘  └─────┬─────┘    │
│        │              │              │              │           │
│        └──────────────┼──────────────┼──────────────┘           │
│                       ▼                                         │
│              ┌─────────────────┐                                │
│              │   SwinUNet 模型  │                                │
│              │    model.py     │                                │
│              └────────┬────────┘                                │
│                       │                                         │
│        ┌──────────────┼──────────────┐                          │
│        ▼              ▼              ▼                          │
│  ┌──────────┐  ┌──────────────┐  ┌──────────┐                  │
│  │ 数据加载 │  │   预处理     │  │ 几何归一化│                  │
│  │ data.py  │  │preprocessing │  │geometric_ │                  │
│  └──────────┘  └──────────────┘  └──────────┘                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 核心模块

### 1. SwinUNet 模型 (`model.py`)

```
输入: 眼部图像 (36×60×3)
      ↓
┌─────────────────────────────────┐
│         Patch Embedding          │
│      (4×4 patches → tokens)      │
└──────────────┬──────────────────┘
               ↓
┌─────────────────────────────────┐
│      Swin Transformer Encoder    │
│  Stage 1: 9×15 → Window Attn    │
│  Stage 2: 5×8  → Window Attn    │
│  Stage 3: 3×4  → Window Attn    │
│  Stage 4: 2×2  → Window Attn    │
└──────────────┬──────────────────┘
               ↓
┌─────────────────────────────────┐
│         U-Net Decoder            │
│    (Skip connections + Upsample) │
└──────────────┬──────────────────┘
               ↓
┌─────────────────────────────────┐
│      Regression Head             │
│   Global Avg Pool → FC → 3D     │
└──────────────┬──────────────────┘
               ↓
输出: 3D 注视向量 (x, y, z)
```

**参数量**: ~7.6M
**输入尺寸**: 36×60×3 (H×W×C)
**输出**: 3D 单位向量 (x, y, z)

---

### 2. GUI 可视化器 (`gui_visualizer.py`)

```
视频文件
    ↓
┌─────────────────────────────────┐
│  阶段1: 眨眼扫描 (快速预处理)    │
│  - MediaPipe 人脸检测            │
│  - EAR 计算                      │
│  - 记录所有眨眼时刻              │
└──────────────┬──────────────────┘
               ↓
┌─────────────────────────────────┐
│  阶段2: 完整处理                 │
│  - 眼部 ROI 提取                 │
│  - SwinUNet 推理                 │
│  - 应用对称眨眼窗口 (±300ms)     │
│  - 线性插值填充                  │
└──────────────┬──────────────────┘
               ↓
┌─────────────────────────────────┐
│  信号后处理                      │
│  - 中值滤波 (kernel=5)           │
│  - 低通滤波 (Butterworth, 8Hz)   │
└──────────────┬──────────────────┘
               ↓
┌─────────────────────────────────┐
│  可视化与交互                    │
│  - Matplotlib 曲线图             │
│  - 时间轴拖动                    │
│  - 3D 注视向量显示               │
│  - Plist 导出                    │
└─────────────────────────────────┘
```

**核心类**:
- `GazeVisualizerApp` - 主应用窗口
- `MediaPipeEyeNormalizer` - 眼部检测与归一化
- `SignalProcessor` - 信号滤波处理
- `EyeImagePreprocessor` - 图像预处理

---

### 3. Web 部署 (`js/`)

```
浏览器
    ↓
┌─────────────────────────────────┐
│  demo.html                       │
│  - 视频文件上传                  │
│  - UI 控制                       │
└──────────────┬──────────────────┘
               ↓
┌─────────────────────────────────┐
│  MediaPipe Face Mesh (WASM)     │
│  - 468 个人脸关键点             │
│  - 眼部 ROI 提取                │
└──────────────┬──────────────────┘
               ↓
┌─────────────────────────────────┐
│  ONNX Runtime Web (WASM)        │
│  - swinunet_web.onnx            │
│  - 模型推理                      │
└──────────────┬──────────────────┘
               ↓
┌─────────────────────────────────┐
│  Chart.js                        │
│  - 实时角度曲线                  │
│  - FPS 显示                      │
└─────────────────────────────────┘
```

---

## 数据流

### 训练数据流

```
MPIIGaze 数据集
    │
    ├── Data/Normalized/p00-p14/
    │       │
    │       ▼
    │   ┌─────────────┐
    │   │ .mat 文件    │
    │   │ - 眼部图像   │
    │   │ - 3D 向量    │
    │   └──────┬──────┘
    │          │
    ▼          ▼
┌──────────────────────┐
│   data.py            │
│   MPIIGazeDataset    │
│   - 加载 .mat        │
│   - 数据增强         │
│   - 批次采样         │
└──────────┬───────────┘
           │
           ▼
┌──────────────────────┐
│   train.py           │
│   - 前向传播         │
│   - 损失计算         │
│   - 反向传播         │
│   - 检查点保存       │
└──────────────────────┘
```

### 推理数据流

```
视频帧 (1920×1080)
    │
    ▼
┌──────────────────────┐
│  MediaPipe 人脸检测   │
│  - 468 关键点        │
│  - 眼部区域定位      │
└──────────┬───────────┘
           │
           ▼
┌──────────────────────┐
│  眼部 ROI 提取       │
│  - 裁剪 + 缩放       │
│  - 输出: 36×60×3     │
└──────────┬───────────┘
           │
           ▼
┌──────────────────────┐
│  预处理              │
│  - 归一化 [0,1]      │
│  - 标准化            │
│  - 转 Tensor         │
└──────────┬───────────┘
           │
           ▼
┌──────────────────────┐
│  SwinUNet 推理       │
│  - 输出: (x, y, z)   │
└──────────┬───────────┘
           │
           ▼
┌──────────────────────┐
│  角度转换            │
│  pitch = arcsin(-y)  │
│  yaw = atan2(-x,-z)  │
└──────────────────────┘
```

---

## 模块依赖

```
model.py
    │
    └── torch, torch.nn

train.py
    ├── model.py
    ├── data.py
    └── torch, tqdm

test.py
    ├── model.py
    ├── data.py
    └── visualize_results.py

gui_visualizer.py
    ├── model.py
    ├── preprocessing.py
    ├── mediapipe
    ├── customtkinter
    ├── matplotlib
    └── scipy

export_to_onnx.py
    ├── model.py
    └── onnx, torch.onnx
```

---

## 文件结构

```
SwinUNet-VOG/
├── 核心代码
│   ├── model.py              # SwinUNet 模型
│   ├── train.py              # 训练脚本
│   ├── test.py               # 评估脚本
│   ├── data.py               # 数据加载
│   ├── preprocessing.py      # 预处理
│   ├── geometric_normalization.py
│   ├── gui_visualizer.py     # GUI 工具
│   ├── visualize_results.py  # 结果可视化
│   └── export_to_onnx.py     # ONNX 导出
│
├── 资源
│   ├── checkpoints/          # 模型权重
│   ├── models/               # 导出模型
│   └── MPIIGaze/             # 数据集
│
├── Web 部署
│   └── js/
│       ├── demo.html
│       ├── server.py
│       ├── swinunet-gaze-api.js
│       └── lib/              # JS 依赖
│
└── 文档
    ├── README.md
    ├── PERFORMANCE.md
    └── .cursor/rules/        # Cursor 规则
```

