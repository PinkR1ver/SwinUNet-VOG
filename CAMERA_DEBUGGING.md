# 摄像头问题诊断指南 🔍

当 `capture.py` 无法读取摄像头帧时，按照以下步骤排查。

## 🚨 症状：摄像头读取失败

```
❌ 错误：未能从摄像头获取任何帧！
摄像头读取失败，中止录制。
```

---

## 📋 快速诊断流程

### 步骤 1️⃣ : 检查摄像头是否被占用

```bash
# macOS
lsof | grep "camera\|video"

# 或检查系统进程
ps aux | grep -E "Zoom|OBS|FaceTime|Photo"
```

**如果看到摄像头进程：**
- ❌ 关闭 OBS、Zoom、FaceTime 等应用
- ❌ 重新启动 capture.py

---

### 步骤 2️⃣ : 运行 OpenCV 兼容性测试

```bash
python3 detect_camera.py
```

这会显示：
- ✅ USB 设备信息
- ✅ OpenCV 能否打开摄像头
- ✅ 支持的分辨率/帧率组合

**预期输出示例：**

```
🔧 OpenCV 摄像头兼容性测试
============================================================

[1/3] 尝试打开摄像头索引 0...
   ✅ 摄像头已打开

[2/3] 检测默认格式...
   ✅ 能读取帧：(480, 640, 3)
   数据类型：uint8

[3/3] 尝试常见参数组合...
   ✅ 640×480@30FPS → 640×480@30FPS
   ✅ 1280×720@30FPS → 1280×720@30FPS
   ✅ 1920×1080@30FPS → 1920×1080@30FPS
   ✅ 1280×720@60FPS → 1280×720@60FPS
   ❌ 1920×1080@60FPS → 0×0@0FPS      ← 摄像头不支持
   ❌ 1920×1080@120FPS → 0×0@0FPS     ← 摄像头不支持
```

---

### 步骤 3️⃣ : 根据测试结果调整

#### 如果 `[1/3]` 失败 ❌

**摄像头根本打不开**

检查清单：
1. ✅ 摄像头是否连接？
   ```bash
   system_profiler SPUSBDataType | grep -i camera
   ```

2. ✅ 权限是否授予？
   - 系统偏好设置 > 隐私 > 摄像头 > 允许 Python

3. ✅ 摄像头是否被占用？
   ```bash
   lsof | grep AppleCamera
   ```

4. ✅ 尝试重新插拔摄像头

---

#### 如果 `[2/3]` 失败 ❌

**摄像头打开了，但读不到帧**

原因通常是：
- 格式协商失败（驱动 bug）
- USB 连接不稳定
- 需要等待更长的初始化时间

**解决方案：**
```bash
# 修改 capture.py，增加等待时间
# 在第 730 行左右，改成：
time.sleep(2)  # 从 0.5 改为 2.0
```

---

#### 如果 `[3/3]` 显示某些分辨率失败 ❌

**摄像头不支持该参数组合**

例如：
```
❌ 1920×1080@120FPS → 0×0@0FPS
```

意味着摄像头不支持 1080p@120fps。

**解决方案：**
在 `capture.py` UI 中，只使用标记 ✅ 的组合。

---

## 🔧 常见问题排查表

| 现象 | 原因 | 解决方案 |
|------|------|--------|
| `cap.isOpened()` 成功，但 `cap.read()` 失败 | 格式协商问题 | 增加初始化等待时间 |
| OpenCV 无法打开摄像头 | 被其他应用占用 | 关闭 OBS/Zoom，重启 |
| 特定分辨率失败 | 摄像头不支持 | 尝试更低的分辨率 |
| 特定帧率失败 | USB 带宽不足 | 降低帧率或用 MJPEG |
| 高分辨率文件无法播放 | AVI 容器崩溃 | 强制使用 MP4（已自动） |

---

## 📊 完整诊断步骤

如果仍然失败，运行完整诊断：

```bash
#!/bin/bash

echo "=== 摄像头完整诊断 ==="
echo ""

echo "1. USB 设备检查"
system_profiler SPUSBDataType | grep -A 20 "Camera\|Video\|Capture"
echo ""

echo "2. ioreg 详细信息"
ioreg -l | grep -A 10 "HD USB Camera" 2>/dev/null || echo "未找到摄像头"
echo ""

echo "3. OpenCV 测试"
python3 detect_camera.py
echo ""

echo "4. 进程检查"
ps aux | grep -E "OBS|Zoom|FaceTime|Photo" | grep -v grep
echo ""

echo "完成！"
```

保存为 `diagnose.sh`，运行：
```bash
chmod +x diagnose.sh
./diagnose.sh
```

---

## 🎯 最终解决方案

如果 `detect_camera.py` 显示：

### ✅ 好消息：摄像头支持该分辨率/帧率

在 `capture.py` UI 中直接使用那个参数组合录制。

---

### ⚠️ 坏消息：摄像头不支持

**选择支持的最高组合**，例如：

原需求：`1920×1080@120FPS`
发现摄像头只支持：`1920×1080@60FPS`

那就用 `1920×1080@60FPS`，不然无法录制。

---

### 💡 高帧率优化建议

如果需要 1080p@120fps 但摄像头只支持 1080p@60fps：

**选项 1：换个摄像头** ❌（不现实）

**选项 2：降低分辨率** ✅

试试看：
- 720p@120FPS（如果摄像头支持）
- 1080p@60FPS（降低帧率）

**选项 3：检查编码格式**

如果用的是 YUY2（无损）：
- 可能超出 USB 2.0 带宽（480 Mbps）
- 改用 MJPEG 试试

---

## 📞 仍然无法解决？

提供以下信息给我：

1. `python3 detect_camera.py` 的完整输出
2. 希望录制的参数（分辨率、帧率、编码）
3. 编码格式选择
4. 错误信息

例如：
```
摄像头型号：HD USB Camera
USB 协议：USB 2.0
需要：1920×1080@120FPS YUY2
实际支持：1920×1080@30FPS（根据 detect_camera.py）
```


